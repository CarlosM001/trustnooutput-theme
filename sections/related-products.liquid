{%- if product and section.settings.enable_product_recommendations -%}
  <product-recommendations
    class="related-products page-width"
    data-section-id="{{ section.id }}"
    data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.products_to_show }}&intent=related"
  >
    {%- liquid
      assign display_style = 'none'
      assign source = ''

      if recommendations.performed and recommendations.products_count > 0
        assign display_style = 'block'
        assign source = 'recommendations'
      else
        assign fallback_collection = product.collections.first
        if fallback_collection and fallback_collection.products_count > 1
          assign display_style = 'block'
          assign source = 'collection'
        endif
      endif
    -%}

    <div
      class="related-products__inner color-{{ section.settings.color_scheme }} gradient"
      style="display: {{ display_style }};"
    >
      <div class="related-products__heading-wrapper">
        <h2 class="related-products__heading h2">
          {{ section.settings.heading | escape }}
        </h2>
      </div>

      {%- if source != '' -%}
        <div class="tno-related-products">
          <div class="tno-related-products__controls" aria-hidden="false">
            <button
              type="button"
              class="tno-related-products__control tno-related-products__control--prev"
              aria-label="Previous related product"
            >
              ‹
            </button>
            <button
              type="button"
              class="tno-related-products__control tno-related-products__control--next"
              aria-label="Next related product"
            >
              ›
            </button>
          </div>
          <ul
            class="tno-related-products__track"
            id="product-grid-{{ section.id }}"
          >
            {%- if source == 'recommendations' -%}
              {%- for related_product in recommendations.products
                limit: section.settings.products_to_show
              -%}
                <li class="tno-related-products__item{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
                  {% render 'card-product',
                    card_product: related_product,
                    media_aspect_ratio: settings.card_image_ratio,
                    image_shape: settings.card_image_shape,
                    show_secondary_image: settings.card_show_secondary_image,
                    show_vendor: settings.card_show_vendor,
                    show_rating: settings.card_show_rating,
                    section_id: section.id,
                    show_color_variants: true,
                    show_custom_add_to_cart: true,
                    card_style: 'trust'
                  %}
                </li>
              {%- endfor -%}
            {%- elsif source == 'collection' -%}
              {%- for related_product in fallback_collection.products
                limit: section.settings.products_to_show
              -%}
                {%- if related_product.id == product.id -%}
                  {%- continue -%}
                {%- endif -%}
                <li class="tno-related-products__item{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
                  {% render 'card-product',
                    card_product: related_product,
                    media_aspect_ratio: settings.card_image_ratio,
                    image_shape: settings.card_image_shape,
                    show_secondary_image: settings.card_show_secondary_image,
                    show_vendor: settings.card_show_vendor,
                    show_rating: settings.card_show_rating,
                    section_id: section.id,
                    show_color_variants: true,
                    show_custom_add_to_cart: true,
                    card_style: 'trust'
                  %}
                </li>
              {%- endfor -%}
            {%- endif -%}
          </ul>
        </div>
      {%- endif -%}
    </div>
  </product-recommendations>
{%- endif -%}

{% schema %}
{
  "name": "Related products",
  "tag": "section",
  "class": "section related-products-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_product_recommendations",
      "default": true,
      "label": "Ähnliche Produkte anzeigen"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Überschrift",
      "default": "Related products"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Anzahl Produkte",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Spalten (Desktop)",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Spalten (Mobilgeräte)",
      "default": "2",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ]
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Farbschema",
      "default": "scheme-1",
      "options": [
        {
          "value": "scheme-1",
          "label": "Schema 1"
        },
        {
          "value": "scheme-2",
          "label": "Schema 2"
        },
        {
          "value": "scheme-3",
          "label": "Schema 3"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Related products",
      "category": "Product"
    }
  ]
}
{% endschema %}
